name: æ¸¸æˆç›‘æ§

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
    
    - name: è¿è¡Œç›‘æ§
      run: |
        python monitor.py
    
    - name: è¯»å–æ£€æµ‹ç»“æœ
      id: check_result
      run: |
        if [ -f has_new_games.txt ]; then
          HAS_NEW=$(cat has_new_games.txt)
          echo "has_new_games=$HAS_NEW" >> $GITHUB_OUTPUT
        else
          echo "has_new_games=false" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆ›å»º Issueï¼ˆå¦‚æœæœ‰æ–°æ¸¸æˆï¼‰
      if: steps.check_result.outputs.has_new_games == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('report.md', 'utf8');
          const date = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ® å‘ç°æ–°æ¸¸æˆ - ${date}`,
            body: report,
            labels: ['new-games', 'automated']
          });
    
    - name: æäº¤æ•°æ®æ›´æ–°
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add games_data.json
        git diff --quiet && git diff --staged --quiet || git commit -m "æ›´æ–°æ¸¸æˆæ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')"
    
    - name: æ¨é€æ›´æ”¹
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
