# 📱 企业微信机器人配置指南

## 🎯 配置步骤

### 第一步：创建企业微信群机器人

#### 1. 创建群聊
- 打开企业微信
- 创建一个新的群聊（或使用现有群聊）
- 建议命名为"游戏监控通知"

#### 2. 添加群机器人
1. 进入群聊
2. 点击右上角 `···` 菜单
3. 选择「群机器人」
4. 点击「添加机器人」
5. 选择「新创建一个机器人」

#### 3. 配置机器人
1. 机器人名称：`游戏监控助手`（或自定义）
2. 点击「添加」
3. **重要**：复制 Webhook 地址（类似：`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx`）

### 第二步：配置 GitHub Secret

1. 进入你的 GitHub 仓库
2. 点击 **Settings** → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**
4. 填写：
   - **Name**: `WECOM_WEBHOOK`
   - **Secret**: 粘贴刚才复制的 Webhook 地址
5. 点击 **Add secret**

### 第三步：推送代码并测试

```bash
# 提交并推送代码
git add .
git commit -m "配置企业微信推送"
git push

# 然后在 GitHub Actions 手动触发测试
```

1. 进入 GitHub 仓库的 **Actions** 标签
2. 选择「游戏监控」工作流
3. 点击 **Run workflow**
4. 等待运行完成
5. 检查企业微信群是否收到消息

## 📬 推送效果

当发现新游戏时，企业微信群会收到：

```
## 🎮 AZGames 新游戏通知

**检测时间**: 2025-11-20 11:24:00

### 📂 热门趋势游戏
- **总游戏数**: 26
- **新增游戏**: 3

**新游戏列表**:
1. [Slope Rider](https://azgames.io/slope-rider)
2. [Steal Brainrots](https://azgames.io/steal-brainrots)
3. [Undead Corridor](https://azgames.io/undead-corridor)

> 💡 点击游戏名称即可访问
```

## ✨ 优势

✅ **完全免费** - 无消息数量限制
✅ **实时推送** - 发现新游戏立即通知
✅ **支持 Markdown** - 格式美观，支持链接
✅ **多人接收** - 群内所有成员都能收到
✅ **企业级稳定** - 腾讯官方服务

## 🔧 高级配置

### 1. 自定义消息格式

如果想修改推送的消息格式，编辑 `.github/workflows/monitor.yml` 中的内容部分：

```yaml
"content": "## 🎮 自定义标题\n\n**时间**: ${DATE}\n\n${REPORT}"
```

### 2. 添加 @提醒

企业微信机器人支持 @群成员：

```yaml
"content": "## 🎮 新游戏通知\n\n<@userid1> <@userid2>\n\n${REPORT}"
```

获取 userid 方法：
1. 企业微信管理后台
2. 通讯录 → 成员详情
3. 查看账号（即 userid）

### 3. 限制消息长度

如果游戏太多，消息可能过长，可以限制：

```yaml
- name: 推送到企业微信
  run: |
    # 只取前2000字符
    REPORT=$(cat report.md | head -c 2000)
    # 或者只显示游戏数量
    COUNT=$(cat report.md | grep -c "^\[")
    
    curl -X POST "${{ secrets.WECOM_WEBHOOK }}" \
      -H "Content-Type: application/json" \
      -d "{
        \"msgtype\": \"text\",
        \"text\": {
          \"content\": \"🎮 发现 ${COUNT} 个新游戏！\n\n查看详情：https://github.com/${{ github.repository }}/issues\"
        }
      }"
```

### 4. 发送图文消息

企业微信还支持图文消息（需要图片链接）：

```yaml
{
  "msgtype": "news",
  "news": {
    "articles": [
      {
        "title": "发现新游戏",
        "description": "共发现 X 个新游戏",
        "url": "https://github.com/你的仓库/issues",
        "picurl": "图片URL"
      }
    ]
  }
}
```

## 🔐 安全建议

### 1. 保护 Webhook 地址
- ❌ 不要将 Webhook 地址提交到代码中
- ✅ 只存储在 GitHub Secrets 中
- ✅ 定期更换机器人（重新生成 Webhook）

### 2. IP 白名单（可选）
企业微信机器人支持配置 IP 白名单：
1. 进入机器人设置
2. 配置 IP 白名单
3. 添加 GitHub Actions 的 IP 段

### 3. 消息签名验证（可选）
对于更高安全性需求，可以启用消息签名。

## ❓ 常见问题

### Q1: 没有收到消息？

**检查清单**：
- [ ] Webhook 地址是否正确复制
- [ ] GitHub Secret 名称是否为 `WECOM_WEBHOOK`
- [ ] 机器人是否被移除
- [ ] 查看 Actions 日志是否有错误
- [ ] 确认确实检测到了新游戏

### Q2: 消息格式乱码？

**原因**：Markdown 格式问题

**解决**：
- 检查特殊字符是否正确转义
- 使用 `text` 类型而非 `markdown`
- 查看工作流中的 sed 命令是否正确

### Q3: 消息发送失败？

**可能原因**：
1. Webhook 地址过期（重新生成）
2. 机器人被删除（重新添加）
3. 网络问题（查看 Actions 日志）
4. 消息内容过长（限制长度）

### Q4: 可以同时推送到多个群吗？

**可以！** 添加多个机器人：

```yaml
- name: 推送到企业微信群1
  if: steps.check_result.outputs.has_new_games == 'true'
  run: |
    curl -X POST "${{ secrets.WECOM_WEBHOOK_1 }}" ...

- name: 推送到企业微信群2
  if: steps.check_result.outputs.has_new_games == 'true'
  run: |
    curl -X POST "${{ secrets.WECOM_WEBHOOK_2 }}" ...
```

在 GitHub Secrets 中分别添加 `WECOM_WEBHOOK_1` 和 `WECOM_WEBHOOK_2`。

### Q5: 企业微信和个人微信有什么区别？

| 特性 | 企业微信 | 个人微信（Server酱） |
|------|---------|---------------------|
| 费用 | 完全免费 | 免费版每天5条 |
| 消息数量 | 无限制 | 有限制 |
| 接收方式 | 群聊 | 公众号 |
| 配置难度 | 简单 | 更简单 |
| 适用场景 | 团队协作 | 个人使用 |

## 🎯 测试命令

如果想手动测试 Webhook 是否正常，可以在终端执行：

```bash
# 替换 YOUR_WEBHOOK_URL 为你的实际地址
curl -X POST "YOUR_WEBHOOK_URL" \
  -H "Content-Type: application/json" \
  -d '{
    "msgtype": "text",
    "text": {
      "content": "测试消息：企业微信机器人配置成功！"
    }
  }'
```

如果配置正确，群里会立即收到测试消息。

## 📊 消息类型对比

企业微信机器人支持多种消息类型：

| 类型 | 说明 | 适用场景 |
|------|------|---------|
| text | 纯文本 | 简单通知 |
| markdown | Markdown格式 | 格式化内容（推荐）✅ |
| image | 图片 | 图表展示 |
| news | 图文 | 丰富展示 |
| file | 文件 | 数据下载 |

当前配置使用的是 **markdown** 类型，支持：
- 标题（#）
- 加粗（**文字**）
- 链接（[文字](URL)）
- 引用（>）
- 列表（-）

## 🔄 从 Server酱 迁移

如果之前使用 Server酱，现在想换成企业微信：

1. 保留原有的 `SERVERCHAN_KEY`（作为备用）
2. 添加新的 `WECOM_WEBHOOK`
3. 两种推送会同时生效
4. 如果只想用企业微信，删除 Server酱 Secret 即可

## 📝 配置检查清单

完成配置后，请检查：

- [ ] 已创建企业微信群机器人
- [ ] 已复制 Webhook 地址
- [ ] 已在 GitHub Secrets 添加 `WECOM_WEBHOOK`
- [ ] 已推送更新后的代码
- [ ] 已手动触发测试
- [ ] 群内收到测试消息
- [ ] 消息格式正常显示

---

**配置完成！现在每次发现新游戏都会推送到企业微信群了！** 🎉
